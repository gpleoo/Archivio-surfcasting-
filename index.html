<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Archivio Surfcasting</title>

  <!-- SEO & Social -->
  <meta name="description" content="Gestisci e archivia tutto il tuo materiale da surfcasting: travi, terminali, piombi, fili, canne, mulinelli e molto altro." />
  <meta name="keywords" content="surfcasting, pesca, archivio, travi, terminali, piombi, mulinelli, canne" />
  <meta name="author" content="Archivio Surfcasting" />

  <!-- PWA / Store -->
  <meta name="theme-color" content="#5ba4f5" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Surfcasting" />
  <meta name="application-name" content="Archivio Surfcasting" />
  <meta name="msapplication-TileColor" content="#0b0f14" />
  <meta name="format-detection" content="telephone=no" />

  <!-- Open Graph -->
  <meta property="og:title" content="Archivio Surfcasting" />
  <meta property="og:description" content="L'app per archiviare tutto il tuo equipaggiamento da surfcasting." />
  <meta property="og:type" content="website" />

  <!-- Manifest & Icons -->
  <link rel="manifest" href="manifest.json" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    /* ‚îÄ‚îÄ RESET & BASE ‚îÄ‚îÄ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg:         #0b0f14;
      --surface:    #141a22;
      --surface-2:  #1c2430;
      --surface-3:  #28323f;
      --border:     #2a3545;
      --border-light:#3a4a5c;
      --accent:     #5ba4f5;
      --accent-glow: rgba(91,164,245,.15);
      --accent-dim: #1d3a6a;
      --text:       #ecf0f6;
      --text-secondary: #b8c4d4;
      --text-muted: #8899ae;
      --success:    #4ade80;
      --warning:    #f0b429;
      --danger:     #f87171;
      --radius:     10px;
      --radius-lg:  14px;
      --shadow:     0 8px 32px rgba(0,0,0,.45);
      --shadow-sm:  0 2px 8px rgba(0,0,0,.3);
      --transition: .2s ease;
    }
    html { font-size: 16px; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    button { font-family: inherit; cursor: pointer; border: none; outline: none; transition: all var(--transition); }
    button:active { transform: scale(.97); }
    input, select, textarea { font-family: inherit; font-size: .95rem; }
    a { color: var(--accent); text-decoration: none; }

    /* ‚îÄ‚îÄ NAVBAR ‚îÄ‚îÄ */
    .navbar {
      position: sticky; top: 0; z-index: 200;
      background: rgba(11,15,20,.85);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-bottom: 1px solid var(--border);
      padding: .85rem 1.5rem;
      display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;
    }
    .navbar-brand {
      display: flex; align-items: center; gap: .6rem;
      font-weight: 800; font-size: 1.2rem; color: var(--text); white-space: nowrap;
      letter-spacing: -.01em;
    }
    .navbar-brand span.logo { font-size: 1.5rem; }
    .navbar-search {
      flex: 1; min-width: 200px; max-width: 400px;
      display: flex; align-items: center; gap: .6rem;
      background: var(--surface-2); border: 1px solid var(--border);
      border-radius: var(--radius); padding: .5rem .9rem;
      transition: border-color var(--transition), box-shadow var(--transition);
    }
    .navbar-search:focus-within {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }
    .navbar-search input {
      background: transparent; border: none; color: var(--text);
      width: 100%; outline: none; font-size: .95rem;
    }
    .navbar-search input::placeholder { color: var(--text-muted); }
    .navbar-search .icon { color: var(--text-muted); font-size: 1rem; }
    .navbar-actions { display: flex; gap: .5rem; margin-left: auto; flex-wrap: wrap; }
    .btn {
      display: inline-flex; align-items: center; gap: .4rem;
      padding: .5rem 1rem; border-radius: var(--radius);
      font-size: .875rem; font-weight: 600; line-height: 1.2;
      transition: all var(--transition);
    }
    .btn-accent { background: var(--accent); color: #0b0f14; }
    .btn-accent:hover { background: #78b8f8; box-shadow: 0 0 0 3px var(--accent-glow); }
    .btn-ghost { background: var(--surface-2); color: var(--text-secondary); border: 1px solid var(--border); }
    .btn-ghost:hover { background: var(--surface-3); color: var(--text); border-color: var(--border-light); }
    .btn-danger { background: rgba(248,113,113,.1); color: var(--danger); border: 1px solid rgba(248,113,113,.25); }
    .btn-danger:hover { background: rgba(248,113,113,.2); border-color: rgba(248,113,113,.4); }
    .btn-success { background: rgba(74,222,128,.1); color: var(--success); border: 1px solid rgba(74,222,128,.25); }
    .btn-success:hover { background: rgba(74,222,128,.2); border-color: rgba(74,222,128,.4); }

    /* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
    .main { max-width: 1140px; margin: 0 auto; padding: 1.75rem 1.25rem 4rem; }

    /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
    #toast {
      position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 9999;
      background: var(--surface-3); border: 1px solid var(--border-light);
      color: var(--text); padding: .75rem 1.25rem; border-radius: var(--radius);
      font-size: .9rem; font-weight: 600; box-shadow: var(--shadow);
      display: flex; align-items: center; gap: .5rem;
      transform: translateY(80px); opacity: 0;
      transition: transform .3s, opacity .3s;
      pointer-events: none;
    }
    #toast.show { transform: translateY(0); opacity: 1; }
    #toast.toast-success { border-color: var(--success); color: var(--success); }
    #toast.toast-error   { border-color: var(--danger);  color: var(--danger); }

    /* ‚îÄ‚îÄ SECTION CARD ‚îÄ‚îÄ */
    .section-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      margin-bottom: 1.1rem;
      overflow: hidden;
      box-shadow: var(--shadow-sm);
      transition: border-color var(--transition), box-shadow var(--transition);
    }
    .section-card:hover { border-color: var(--border-light); }
    .section-card.open { box-shadow: var(--shadow-sm), 0 0 0 1px var(--border); }
    .section-header {
      display: flex; align-items: center; gap: .85rem;
      padding: 1rem 1.25rem; cursor: pointer;
      user-select: none;
      transition: background var(--transition);
    }
    .section-header:hover { background: var(--surface-2); }
    .section-icon { font-size: 1.5rem; }
    .section-title { font-size: 1.1rem; font-weight: 700; flex: 1; letter-spacing: -.01em; }
    .section-badge {
      background: var(--accent-dim); color: var(--accent);
      font-size: .8rem; font-weight: 700; padding: .2rem .65rem;
      border-radius: 20px; min-width: 28px; text-align: center;
    }
    .section-header-actions { display: flex; align-items: center; gap: .5rem; }
    .section-header-actions .btn { padding: .4rem .75rem; font-size: .82rem; }
    .chevron {
      color: var(--text-muted); font-size: .9rem;
      transition: transform var(--transition); display: inline-block;
    }
    .section-card.open .chevron { transform: rotate(180deg); }

    .section-body {
      max-height: 0; overflow: hidden;
      transition: max-height .35s cubic-bezier(.4,0,.2,1);
    }
    .section-card.open .section-body { max-height: 9000px; }
    .section-body-inner { padding: .25rem 1.25rem 1.25rem; }

    /* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
    .table-wrap { overflow-x: auto; border-radius: var(--radius); border: 1px solid var(--border); }
    table { width: 100%; border-collapse: collapse; font-size: .925rem; }
    thead { background: var(--surface-2); }
    th {
      padding: .75rem 1rem; text-align: left; font-weight: 700;
      color: var(--text-secondary); font-size: .82rem; text-transform: uppercase;
      letter-spacing: .05em; white-space: nowrap;
      border-bottom: 2px solid var(--border);
    }
    td {
      padding: .75rem 1rem; border-bottom: 1px solid var(--border);
      vertical-align: middle; word-break: break-word;
      color: var(--text);
    }
    tr:last-child td { border-bottom: none; }
    tbody tr { transition: background var(--transition); }
    tbody tr:nth-child(even) td { background: rgba(255,255,255,.015); }
    tbody tr:hover td { background: var(--surface-2); }
    .td-actions { display: flex; gap: .35rem; justify-content: flex-end; white-space: nowrap; }
    .td-actions button { background: transparent; padding: .35rem .5rem; border-radius: 8px; font-size: .95rem; color: var(--text-muted); }
    .td-actions button:hover { background: var(--surface-3); color: var(--text); }
    .td-actions .btn-del:hover { color: var(--danger); background: rgba(248,113,113,.1); }
    .empty-row td { text-align: center; color: var(--text-muted); padding: 2.5rem 1rem; font-size: .95rem; font-style: italic; }

    /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
    .modal-backdrop {
      position: fixed; inset: 0; z-index: 500;
      background: rgba(0,0,0,.7); backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      display: flex; align-items: center; justify-content: center;
      padding: 1rem; animation: fadeIn .15s;
    }
    @keyframes fadeIn { from { opacity: 0 } to { opacity: 1 } }
    .modal {
      background: var(--surface); border: 1px solid var(--border-light);
      border-radius: var(--radius-lg); box-shadow: var(--shadow);
      width: 100%; max-width: 580px; max-height: 90vh;
      display: flex; flex-direction: column;
      animation: slideUp .2s ease;
    }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0 } to { transform: translateY(0); opacity: 1 } }
    .modal-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 1.1rem 1.4rem; border-bottom: 1px solid var(--border);
    }
    .modal-header h3 { font-size: 1.1rem; font-weight: 700; }
    .modal-close {
      background: transparent; color: var(--text-muted); font-size: 1.3rem;
      line-height: 1; padding: .3rem .5rem; border-radius: var(--radius);
    }
    .modal-close:hover { background: var(--surface-2); color: var(--text); }
    .modal-body { padding: 1.25rem 1.4rem; overflow-y: auto; flex: 1; }
    .modal-footer {
      display: flex; justify-content: flex-end; gap: .6rem;
      padding: 1rem 1.4rem; border-top: 1px solid var(--border);
    }

    /* ‚îÄ‚îÄ FORM ‚îÄ‚îÄ */
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: .9rem; }
    .form-group { display: flex; flex-direction: column; gap: .35rem; }
    .form-group.full { grid-column: 1 / -1; }
    .form-group label { font-size: .82rem; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: .05em; }
    .form-group input,
    .form-group select,
    .form-group textarea {
      background: var(--surface-2); border: 1px solid var(--border);
      border-radius: var(--radius); padding: .6rem .85rem; color: var(--text);
      font-size: .95rem;
      transition: border-color var(--transition), box-shadow var(--transition);
    }
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      border-color: var(--accent); outline: none;
      box-shadow: 0 0 0 3px var(--accent-glow);
    }
    .form-group select option { background: var(--surface-2); }
    .form-group textarea { resize: vertical; min-height: 72px; }

    /* ‚îÄ‚îÄ FIELDS MODAL ‚îÄ‚îÄ */
    .fields-list { display: flex; flex-direction: column; gap: .55rem; margin-bottom: 1rem; }
    .field-row {
      display: flex; align-items: center; gap: .6rem;
      background: var(--surface-2); border: 1px solid var(--border);
      border-radius: var(--radius); padding: .6rem .85rem;
    }
    .field-row .field-label { flex: 1; font-size: .95rem; font-weight: 500; }
    .field-row .field-type { font-size: .8rem; color: var(--text-muted); background: var(--surface-3); padding: .15rem .5rem; border-radius: 6px; font-weight: 600; }
    .field-row .field-default { font-size: .78rem; color: var(--text-muted); font-style: italic; }
    .field-row .btn-del-field { background: transparent; color: var(--text-muted); padding: .25rem .4rem; border-radius: 6px; font-size: .9rem; }
    .field-row .btn-del-field:hover { background: rgba(248,113,113,.15); color: var(--danger); }
    .add-field-form {
      display: grid; grid-template-columns: 1fr auto auto; gap: .55rem;
      align-items: center; margin-top: .6rem;
    }
    .add-field-form input, .add-field-form select {
      background: var(--surface-2); border: 1px solid var(--border);
      border-radius: var(--radius); padding: .55rem .75rem; color: var(--text); font-size: .9rem;
    }
    .add-field-form input:focus, .add-field-form select:focus {
      border-color: var(--accent); outline: none;
      box-shadow: 0 0 0 3px var(--accent-glow);
    }

    /* ‚îÄ‚îÄ CONFIRM INLINE ‚îÄ‚îÄ */
    .confirm-row {
      display: flex; align-items: center; gap: .5rem;
      background: rgba(248,113,113,.08); border: 1px solid rgba(248,113,113,.25);
      border-radius: var(--radius); padding: .5rem .85rem; font-size: .9rem;
    }
    .confirm-row span { flex: 1; color: var(--danger); font-weight: 600; }

    /* ‚îÄ‚îÄ COLLAPSE ALL / EXPAND ALL ‚îÄ‚îÄ */
    .toolbar { display: flex; gap: .6rem; margin-bottom: 1.25rem; flex-wrap: wrap; align-items: center; }
    .toolbar-title { font-size: .85rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: .05em; margin-right: .5rem; }

    /* ‚îÄ‚îÄ HIGHLIGHT ‚îÄ‚îÄ */
    mark { background: rgba(91,164,245,.25); color: var(--text); border-radius: 3px; padding: .05em .15em; }

    /* ‚îÄ‚îÄ SCROLLBAR ‚îÄ‚îÄ */
    ::-webkit-scrollbar { width: 7px; height: 7px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--surface-3); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

    /* ‚îÄ‚îÄ GEAR DROPDOWN ‚îÄ‚îÄ */
    .gear-wrapper {
      position: relative;
    }
    .btn-settings-gear {
      background: transparent; color: var(--text-muted);
      padding: .45rem .55rem; border-radius: var(--radius);
      font-size: 1.25rem; line-height: 1;
      border: 1px solid var(--border);
      transition: all var(--transition);
    }
    .btn-settings-gear:hover { background: var(--surface-2); color: var(--text); border-color: var(--border-light); }
    .btn-settings-gear.active { color: var(--accent); border-color: var(--accent-dim); background: var(--accent-glow); }

    .gear-dropdown {
      display: none;
      position: fixed; top: 3.5rem; right: 1.5rem;
      min-width: 260px;
      background: var(--surface);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      z-index: 300;
      overflow: hidden;
      animation: slideUp .18s ease;
    }
    .gear-dropdown.open { display: block; }
    .gear-dropdown-title {
      padding: .7rem 1rem;
      font-size: .78rem; font-weight: 700;
      color: var(--text-muted); text-transform: uppercase; letter-spacing: .06em;
      border-bottom: 1px solid var(--border);
      background: var(--surface-2);
    }
    .gear-dropdown-actions {
      display: flex; flex-direction: column; gap: 0;
      padding: .5rem;
    }
    .gear-dropdown-actions .btn {
      justify-content: flex-start;
      padding: .7rem .9rem; font-size: .95rem; font-weight: 600;
      width: 100%; border-radius: 8px;
    }

    /* ‚îÄ‚îÄ PARTNER MODAL ‚îÄ‚îÄ */
    .partner-tabs {
      display: flex; gap: 0; border-bottom: 2px solid var(--border);
      margin-bottom: 1.1rem;
    }
    .partner-tab {
      background: transparent; border: none; padding: .6rem 1rem;
      font-size: .88rem; font-weight: 600; color: var(--text-muted);
      border-bottom: 2px solid transparent; margin-bottom: -2px;
      cursor: pointer; transition: color var(--transition), border-color var(--transition);
    }
    .partner-tab:hover { color: var(--text); }
    .partner-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
    .partner-panel { display: none; }
    .partner-panel.active { display: block; }
    .partner-list { display: flex; flex-direction: column; gap: .55rem; margin-bottom: 1rem; }
    .partner-entry {
      background: var(--surface-2); border: 1px solid var(--border);
      border-radius: var(--radius); padding: .7rem 1rem;
      display: flex; align-items: flex-start; gap: .75rem;
    }
    .partner-entry-info { flex: 1; min-width: 0; }
    .partner-entry-name { font-size: .95rem; font-weight: 700; margin-bottom: .15rem; }
    .partner-entry-details { font-size: .82rem; color: var(--text-muted); line-height: 1.5; }
    .partner-entry-details a { color: var(--accent); }
    .partner-entry-actions { display: flex; gap: .3rem; flex-shrink: 0; }
    .partner-entry-actions button { background: transparent; padding: .3rem .4rem; border-radius: 6px; font-size: .9rem; color: var(--text-muted); }
    .partner-entry-actions button:hover { background: var(--surface-3); color: var(--text); }
    .partner-entry-actions .btn-del-p:hover { color: var(--danger); background: rgba(248,113,113,.1); }
    .partner-empty { text-align: center; color: var(--text-muted); padding: 1.5rem 1rem; font-size: .9rem; font-style: italic; }
    .partner-add-btn {
      display: flex; align-items: center; gap: .4rem;
      width: 100%; padding: .6rem .9rem;
      background: var(--accent-glow); border: 1px dashed var(--accent-dim);
      border-radius: var(--radius); color: var(--accent);
      font-size: .88rem; font-weight: 600; cursor: pointer;
      transition: all var(--transition);
    }
    .partner-add-btn:hover { background: rgba(91,164,245,.22); border-color: var(--accent); }
    /* partner sub-form */
    .partner-form {
      background: var(--surface-2); border: 1px solid var(--border-light);
      border-radius: var(--radius); padding: .85rem .9rem;
      display: none; flex-direction: column; gap: .65rem;
      margin-bottom: .75rem;
    }
    .partner-form.open { display: flex; }
    .partner-form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: .6rem; }
    .partner-form-group { display: flex; flex-direction: column; gap: .25rem; }
    .partner-form-group.full { grid-column: 1 / -1; }
    .partner-form-group label { font-size: .78rem; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: .05em; }
    .partner-form-group input,
    .partner-form-group textarea {
      background: var(--surface-3); border: 1px solid var(--border);
      border-radius: 8px; padding: .5rem .75rem; color: var(--text); font-size: .9rem;
      transition: border-color var(--transition), box-shadow var(--transition);
    }
    .partner-form-group input:focus,
    .partner-form-group textarea:focus { border-color: var(--accent); outline: none; box-shadow: 0 0 0 3px var(--accent-glow); }
    .partner-form-group textarea { resize: vertical; min-height: 60px; }
    .partner-form-footer { display: flex; justify-content: flex-end; gap: .5rem; margin-top: .25rem; }

    /* ‚îÄ‚îÄ SAFE AREA (notch / home-bar) ‚îÄ‚îÄ */
    .navbar {
      padding-left:  max(1.5rem, env(safe-area-inset-left));
      padding-right: max(1.5rem, env(safe-area-inset-right));
    }
    .main {
      padding-left:  max(1.25rem, env(safe-area-inset-left));
      padding-right: max(1.25rem, env(safe-area-inset-right));
      padding-bottom: max(4rem, calc(2rem + env(safe-area-inset-bottom)));
    }

    /* ‚îÄ‚îÄ MOBILE CARD VIEW per tabelle ‚îÄ‚îÄ */
    .mobile-card-list { display: none; }
    .mobile-card {
      background: var(--surface-2); border: 1px solid var(--border);
      border-radius: var(--radius); padding: .85rem 1rem;
      margin-bottom: .6rem;
    }
    .mobile-card-row {
      display: flex; justify-content: space-between; align-items: baseline;
      gap: .5rem; padding: .2rem 0;
      border-bottom: 1px solid rgba(255,255,255,.04);
    }
    .mobile-card-row:nth-last-child(2) { border-bottom: none; }
    .mobile-card-key {
      font-size: .75rem; font-weight: 700; color: var(--text-muted);
      text-transform: uppercase; letter-spacing: .04em; flex-shrink: 0;
    }
    .mobile-card-val {
      font-size: .9rem; color: var(--text); text-align: right;
      word-break: break-word; min-width: 0;
    }
    .mobile-card-actions {
      display: flex; gap: .5rem; justify-content: flex-end;
      margin-top: .65rem; padding-top: .5rem;
      border-top: 1px solid var(--border);
    }
    .mobile-card-actions .btn { flex: 1; justify-content: center; font-size: .88rem; min-height: 40px; }

    /* ‚îÄ‚îÄ TABLET (‚â§ 900px) ‚îÄ‚îÄ */
    @media (max-width: 900px) {
      .main { max-width: 100%; }
      th, td { padding: .65rem .85rem; }
    }

    /* ‚îÄ‚îÄ SCORTE BASSE ‚îÄ‚îÄ */
    .low-stock-badge {
      background: rgba(248,113,113,.12); color: var(--danger);
      font-size: .75rem; font-weight: 700; padding: .15rem .5rem;
      border-radius: 12px; white-space: nowrap; display: inline-block; margin-left: .35rem;
    }
    tr.low-stock td { background: rgba(248,113,113,.06) !important; }
    .mobile-card.low-stock { border-color: rgba(248,113,113,.35); }

    /* ‚îÄ‚îÄ COOKIE BANNER ‚îÄ‚îÄ */
    .cookie-banner {
      position: fixed; bottom: 0; left: 0; right: 0; z-index: 1000;
      background: var(--surface); border-top: 1px solid var(--border-light);
      padding: 1.25rem; box-shadow: 0 -4px 24px rgba(0,0,0,.5);
    }
    .cookie-content { max-width: 700px; margin: 0 auto; text-align: center; }
    .cookie-content p { margin-bottom: .5rem; font-size: .9rem; color: var(--text-secondary); }
    .cookie-actions { display: flex; gap: .75rem; justify-content: center; margin-top: .75rem; }

    /* ‚îÄ‚îÄ PARTNER RESTYLE ‚îÄ‚îÄ */
    .partner-banner {
      padding: .75rem 1rem; background: var(--surface-2); border-radius: var(--radius);
      margin-bottom: 1rem; font-size: .85rem; color: var(--text-secondary); text-align: center;
    }
    .partner-icon-circle {
      width: 36px; height: 36px; border-radius: 50%;
      display: inline-flex; align-items: center; justify-content: center;
      font-size: 1.1rem; flex-shrink: 0; margin-right: .6rem;
    }
    .partner-icon-circle.negozi { background: rgba(91,164,245,.15); }
    .partner-icon-circle.associazioni { background: rgba(74,222,128,.15); }
    .partner-icon-circle.maestri { background: rgba(240,180,41,.15); }
    .partner-entry { display: flex; align-items: center; }

    /* ‚îÄ‚îÄ PHABLET (‚â§ 680px) ‚îÄ‚îÄ */
    @media (max-width: 680px) {
      html { font-size: 15px; }
      .form-grid { grid-template-columns: 1fr; }
      .partner-form-grid { grid-template-columns: 1fr; }
      .navbar {
        padding-top: .7rem; padding-bottom: .7rem;
        gap: .6rem;
      }
      .navbar-search { min-width: 0; }
      .section-header { padding: .85rem 1rem; }
      .section-header-actions .btn span.btn-label { display: none; }
      .section-body-inner { padding: .2rem .85rem 1rem; }
      .section-icon { font-size: 1.3rem; }
      .section-title { font-size: 1rem; }
      .gear-dropdown {
        min-width: 230px;
        top: auto;
        bottom: calc(env(safe-area-inset-bottom) + .5rem);
        right: .75rem; left: .75rem;
        width: auto; max-width: 100%;
        max-height: calc(100dvh - 6rem); overflow-y: auto;
      }
      .partner-tabs { overflow-x: auto; flex-wrap: nowrap; }
      .partner-tab { white-space: nowrap; flex-shrink: 0; padding: .55rem .8rem; font-size: .82rem; }
    }

    /* ‚îÄ‚îÄ MOBILE (‚â§ 480px): card-view tabelle ‚îÄ‚îÄ */
    @media (max-width: 480px) {
      html { font-size: 14px; }
      .navbar {
        padding-left:  max(.9rem, env(safe-area-inset-left));
        padding-right: max(.9rem, env(safe-area-inset-right));
      }
      /* Nascondi tabella, mostra card */
      .table-wrap { display: none; }
      .mobile-card-list { display: block; }
      /* Sezione header: nascondi testi bottoni */
      .section-header-actions .btn { padding: .4rem .55rem; font-size: 0; gap: 0; }
      .section-header-actions .btn::before { font-size: .85rem; }
      .btn-add-item::before  { content: '+'; font-size: 1rem; font-weight: 800; }
      .btn-open-fields::before { content: '‚öô'; font-size: .95rem; }
      /* Main padding */
      .main { padding: 1rem .75rem max(3rem, calc(1rem + env(safe-area-inset-bottom))); }
      .section-body-inner { padding: .15rem .65rem .9rem; }
      .toolbar { gap: .4rem; margin-bottom: 1rem; }
      .toolbar-title { display: none; }
      .modal { margin: .5rem; max-height: calc(100dvh - 1rem); border-radius: var(--radius); }
      .modal-body { padding: 1rem 1.1rem; }
      .modal-header, .modal-footer { padding: .85rem 1.1rem; }
      .modal-footer { gap: .5rem; }
      .modal-footer .btn { flex: 1; justify-content: center; min-height: 44px; }
    }

    /* ‚îÄ‚îÄ SMALL PHONE (‚â§ 360px) ‚îÄ‚îÄ */
    @media (max-width: 360px) {
      html { font-size: 13px; }
      .navbar-brand span.logo { font-size: 1.3rem; }
      .navbar-brand { font-size: 1rem; }
    }

    /* ‚îÄ‚îÄ TOUCH: target minimi 44px ‚îÄ‚îÄ */
    @media (pointer: coarse) {
      .btn { min-height: 44px; }
      .btn-settings-gear { min-height: 44px; min-width: 44px; }
      .section-header { min-height: 56px; }
      .td-actions button { min-height: 40px; min-width: 40px; }
      .partner-add-btn { min-height: 44px; }
      .partner-entry-actions button { min-height: 40px; min-width: 40px; }
      .modal-close { min-height: 44px; min-width: 44px; }
    }

    /* ‚îÄ‚îÄ LARGE SCREEN (‚â• 1400px) ‚îÄ‚îÄ */
    @media (min-width: 1400px) {
      .main { max-width: 1300px; }
      html { font-size: 17px; }
    }
  </style>
</head>
<body>

<!-- ‚îÄ‚îÄ COOKIE BANNER ‚îÄ‚îÄ -->
<div id="cookieBanner" class="cookie-banner" style="display:none">
  <div class="cookie-content">
    <p><strong>Cookie &amp; Privacy</strong></p>
    <p>Questa app utilizza localStorage per salvare i tuoi dati localmente sul dispositivo. Nessun dato viene inviato a server esterni.</p>
    <div class="cookie-actions">
      <button class="btn btn-accent" onclick="acceptCookies()">Accetto</button>
      <button class="btn btn-ghost" onclick="openPrivacyModal()">Leggi la Privacy Policy</button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ NAVBAR ‚îÄ‚îÄ -->
<nav class="navbar">
  <div class="navbar-brand">
    <span class="logo">üé£</span>
    Archivio Surfcasting
  </div>
  <div class="navbar-search">
    <span class="icon">üîç</span>
    <input type="text" id="globalSearch" placeholder="Cerca in tutto l'archivio‚Ä¶" oninput="filterAll()" />
  </div>
  <div class="navbar-actions">
    <div class="gear-wrapper">
      <button class="btn-settings-gear" id="settingsGearBtn" onclick="toggleSettingsPanel()" title="Dati">‚öô</button>
    </div>
  </div>
</nav>

<!-- ‚îÄ‚îÄ GEAR DROPDOWN (fuori dalla navbar per evitare il containing block di backdrop-filter) ‚îÄ‚îÄ -->
<div class="gear-dropdown" id="gearDropdown">
  <div class="gear-dropdown-title">Gestione</div>
  <div class="gear-dropdown-actions">
    <button class="btn btn-ghost" onclick="openPartnerModal();toggleSettingsPanel()">ü§ù&nbsp; Partner &amp; Sponsor</button>
  </div>
  <div class="gear-dropdown-title" style="margin-top:.25rem">Impostazioni</div>
  <div class="gear-dropdown-actions">
    <button class="btn btn-ghost" onclick="openPrivacyModal();toggleSettingsPanel()">üîí&nbsp; Privacy Policy</button>
    <button class="btn btn-ghost" onclick="cycleLang()">üåê&nbsp; Lingua: <span id="langLabel">IT</span></button>
  </div>
  <div class="gear-dropdown-title" style="margin-top:.25rem">Dati</div>
  <div class="gear-dropdown-actions">
    <button class="btn btn-ghost" onclick="exportData()">‚¨á&nbsp; Esporta archivio</button>
    <label class="btn btn-ghost" style="cursor:pointer">
      ‚¨Ü&nbsp; Importa archivio
      <input type="file" accept=".json" style="display:none" onchange="importData(event)" />
    </label>
    <button class="btn btn-danger" onclick="confirmClearAll()">üóë&nbsp; Reset completo</button>
  </div>
</div>

<!-- ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ -->
<div class="main">
  <div class="toolbar">
    <span class="toolbar-title">Sezioni:</span>
    <button class="btn btn-ghost" onclick="toggleAll(true)">‚äû Espandi tutto</button>
    <button class="btn btn-ghost" onclick="toggleAll(false)">‚äü Collassa tutto</button>
  </div>
  <div id="sections-container"></div>
</div>

<!-- ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ -->
<div id="toast"></div>

<!-- ‚îÄ‚îÄ MODAL ITEM ‚îÄ‚îÄ -->
<div id="itemModal" class="modal-backdrop" style="display:none" onclick="closeItemModal(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h3 id="itemModalTitle">Aggiungi elemento</h3>
      <button class="modal-close" onclick="closeItemModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-grid" id="itemModalForm"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeItemModal()">Annulla</button>
      <button class="btn btn-accent" onclick="saveItem()">Salva</button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ MODAL FIELDS ‚îÄ‚îÄ -->
<div id="fieldsModal" class="modal-backdrop" style="display:none" onclick="closeFieldsModal(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h3 id="fieldsModalTitle">Gestione campi</h3>
      <button class="modal-close" onclick="closeFieldsModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <p style="font-size:.82rem;color:var(--text-muted);margin-bottom:.85rem;">
        I campi predefiniti non possono essere rimossi. Puoi aggiungere campi custom.
      </p>
      <div class="fields-list" id="fieldsModalList"></div>
      <div class="add-field-form">
        <input type="text" id="newFieldName" placeholder="Nome nuovo campo‚Ä¶" />
        <select id="newFieldType">
          <option value="text">Testo</option>
          <option value="number">Numero</option>
          <option value="textarea">Nota lunga</option>
        </select>
        <button class="btn btn-accent" onclick="addCustomField()">+ Aggiungi</button>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeFieldsModal()">Chiudi</button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ MODAL PARTNER ‚îÄ‚îÄ -->
<div id="partnerModal" class="modal-backdrop" style="display:none" onclick="closePartnerModal(event)">
  <div class="modal" style="max-width:640px" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h3>ü§ù Partner &amp; Sponsor</h3>
      <button class="modal-close" onclick="closePartnerModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="partner-banner" id="partnerBanner">Gestisci i tuoi contatti: negozi, associazioni e maestri di pesca</div>
      <!-- TABS -->
      <div class="partner-tabs">
        <button class="partner-tab active" id="tab-negozi" onclick="switchPartnerTab('negozi',this)">üè™ <span class="tab-label">Negozi di pesca</span> <span class="tab-count" id="count-negozi"></span></button>
        <button class="partner-tab" id="tab-associazioni" onclick="switchPartnerTab('associazioni',this)">üèÖ <span class="tab-label">Associazioni</span> <span class="tab-count" id="count-associazioni"></span></button>
        <button class="partner-tab" id="tab-maestri" onclick="switchPartnerTab('maestri',this)">üéì <span class="tab-label">Maestri di pesca</span> <span class="tab-count" id="count-maestri"></span></button>
      </div>
      <!-- PANEL NEGOZI -->
      <div class="partner-panel active" id="panel-negozi">
        <div class="partner-form" id="form-negozi">
          <div class="partner-form-grid">
            <div class="partner-form-group full"><label>Nome negozio *</label><input type="text" id="neg-nome" placeholder="es. Pesca Sport Roma" /></div>
            <div class="partner-form-group"><label>Telefono</label><input type="text" id="neg-tel" placeholder="es. 06 1234567" /></div>
            <div class="partner-form-group"><label>Email</label><input type="text" id="neg-email" placeholder="es. info@negozio.it" /></div>
            <div class="partner-form-group full"><label>Indirizzo</label><input type="text" id="neg-indirizzo" placeholder="es. Via Roma 12, Roma" /></div>
            <div class="partner-form-group full"><label>Sito web</label><input type="text" id="neg-sito" placeholder="es. https://negozio.it" /></div>
            <div class="partner-form-group full"><label>Note</label><textarea id="neg-note" rows="2"></textarea></div>
          </div>
          <div class="partner-form-footer">
            <button class="btn btn-ghost" onclick="cancelPartnerForm('negozi')">Annulla</button>
            <button class="btn btn-accent" onclick="savePartner('negozi')">Salva</button>
          </div>
        </div>
        <div class="partner-list" id="list-negozi"></div>
        <button class="partner-add-btn" onclick="openPartnerForm('negozi')">+ Aggiungi negozio</button>
      </div>
      <!-- PANEL ASSOCIAZIONI -->
      <div class="partner-panel" id="panel-associazioni">
        <div class="partner-form" id="form-associazioni">
          <div class="partner-form-grid">
            <div class="partner-form-group full"><label>Nome associazione *</label><input type="text" id="ass-nome" placeholder="es. FIPSAS Lazio" /></div>
            <div class="partner-form-group"><label>Telefono</label><input type="text" id="ass-tel" placeholder="es. 06 1234567" /></div>
            <div class="partner-form-group"><label>Email</label><input type="text" id="ass-email" placeholder="es. info@fipsas.it" /></div>
            <div class="partner-form-group full"><label>Descrizione</label><input type="text" id="ass-desc" placeholder="es. Federazione pesca sportiva" /></div>
            <div class="partner-form-group full"><label>Sito web</label><input type="text" id="ass-sito" placeholder="es. https://fipsas.it" /></div>
            <div class="partner-form-group full"><label>Note</label><textarea id="ass-note" rows="2"></textarea></div>
          </div>
          <div class="partner-form-footer">
            <button class="btn btn-ghost" onclick="cancelPartnerForm('associazioni')">Annulla</button>
            <button class="btn btn-accent" onclick="savePartner('associazioni')">Salva</button>
          </div>
        </div>
        <div class="partner-list" id="list-associazioni"></div>
        <button class="partner-add-btn" onclick="openPartnerForm('associazioni')">+ Aggiungi associazione</button>
      </div>
      <!-- PANEL MAESTRI -->
      <div class="partner-panel" id="panel-maestri">
        <div class="partner-form" id="form-maestri">
          <div class="partner-form-grid">
            <div class="partner-form-group full"><label>Nome *</label><input type="text" id="mae-nome" placeholder="es. Mario Rossi" /></div>
            <div class="partner-form-group"><label>Telefono</label><input type="text" id="mae-tel" placeholder="es. 333 1234567" /></div>
            <div class="partner-form-group"><label>Email</label><input type="text" id="mae-email" placeholder="es. mario@pesca.it" /></div>
            <div class="partner-form-group full"><label>Specialit√†</label><input type="text" id="mae-spec" placeholder="es. Surfcasting, Spinning" /></div>
            <div class="partner-form-group full"><label>Note</label><textarea id="mae-note" rows="2"></textarea></div>
          </div>
          <div class="partner-form-footer">
            <button class="btn btn-ghost" onclick="cancelPartnerForm('maestri')">Annulla</button>
            <button class="btn btn-accent" onclick="savePartner('maestri')">Salva</button>
          </div>
        </div>
        <div class="partner-list" id="list-maestri"></div>
        <button class="partner-add-btn" onclick="openPartnerForm('maestri')">+ Aggiungi maestro</button>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closePartnerModal()">Chiudi</button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ MODAL PRIVACY ‚îÄ‚îÄ -->
<div id="privacyModal" class="modal-backdrop" style="display:none" onclick="closePrivacyModal(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h3>üîí Privacy Policy</h3>
      <button class="modal-close" onclick="closePrivacyModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <h4 style="margin-bottom:.75rem">Informativa sulla Privacy</h4>
      <p style="margin-bottom:.5rem;color:var(--text-secondary);font-size:.9rem">
        <strong>Archivio Surfcasting</strong> √® un'applicazione che funziona interamente nel tuo browser.
      </p>
      <ul style="margin:.75rem 0;padding-left:1.2rem;color:var(--text-secondary);font-size:.9rem;line-height:1.7">
        <li><strong>Dati locali:</strong> Tutti i dati sono salvati in localStorage sul tuo dispositivo.</li>
        <li><strong>Nessun server:</strong> Nessun dato viene trasmesso a server esterni.</li>
        <li><strong>Nessun tracciamento:</strong> Non utilizziamo cookie di profilazione n√© analytics.</li>
        <li><strong>Cancellazione:</strong> Puoi eliminare tutti i dati in qualsiasi momento con "Reset completo".</li>
      </ul>
      <p style="margin-top:.75rem;color:var(--text-muted);font-size:.82rem">
        Ultimo aggiornamento: febbraio 2026
      </p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closePrivacyModal()">Chiudi</button>
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  DATA DEFINITIONS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const DEFAULTS = [
  {
    id: 'travi',
    name: 'Travi',
    icon: 'üî©',
    collapsed: true,
    fields: [
      { key: 'numero',      label: 'Numero',        type: 'number',  required: true,  custom: false },
      { key: 'misura',      label: 'Misura',         type: 'text',    required: false, custom: false, placeholder: 'es. 3x100' },
      { key: 'diam_filo',   label: '√ò Filo (mm)',    type: 'text',    required: false, custom: false, placeholder: 'es. 0.35' },
      { key: 'quantita',    label: 'Quantit√†',       type: 'number',  required: false, custom: false },
      { key: 'quantita_min',label: 'Scorta minima',  type: 'number',  required: false, custom: false, placeholder: 'Scorta minima' },
      { key: 'note',        label: 'Note',           type: 'textarea',required: false, custom: false },
    ],
    items: []
  },
  {
    id: 'terminali',
    name: 'Terminali',
    icon: 'ü™ù',
    collapsed: true,
    fields: [
      { key: 'n_ami',       label: 'N¬∞ Ami',            type: 'number',  required: true,  custom: false },
      { key: 'misura_amo',  label: 'Misura Amo',         type: 'text',    required: false, custom: false, placeholder: 'es. 2, 1/0' },
      { key: 'marca_amo',   label: 'Marca Amo',          type: 'text',    required: false, custom: false },
      { key: 'diam_filo',   label: '√ò Filo (mm)',        type: 'text',    required: false, custom: false, placeholder: 'es. 0.30' },
      { key: 'lung_filo',   label: 'Lunghezza Filo (cm)',type: 'number',  required: false, custom: false },
      { key: 'quantita',    label: 'Quantit√†',           type: 'number',  required: false, custom: false },
      { key: 'quantita_min',label: 'Scorta minima',      type: 'number',  required: false, custom: false, placeholder: 'Scorta minima' },
      { key: 'note',        label: 'Note',               type: 'textarea',required: false, custom: false },
    ],
    items: []
  },
  {
    id: 'piombi',
    name: 'Piombi',
    icon: '‚öì',
    collapsed: true,
    fields: [
      { key: 'tipo',        label: 'Tipo',           type: 'text',    required: true,  custom: false, placeholder: 'es. Arpa, Fisso, Scorrevole' },
      { key: 'peso',        label: 'Peso (g)',        type: 'number',  required: false, custom: false },
      { key: 'quantita',    label: 'Quantit√†',        type: 'number',  required: false, custom: false },
      { key: 'quantita_min',label: 'Scorta minima',   type: 'number',  required: false, custom: false, placeholder: 'Scorta minima' },
      { key: 'note',        label: 'Note',            type: 'textarea',required: false, custom: false },
    ],
    items: []
  },
  {
    id: 'fili',
    name: 'Fili',
    icon: 'üßµ',
    collapsed: true,
    fields: [
      { key: 'marca',       label: 'Marca',          type: 'text',    required: true,  custom: false },
      { key: 'tipo',        label: 'Tipo',           type: 'text',    required: false, custom: false, placeholder: 'Mono / Treccia / Fluoro' },
      { key: 'diam',        label: '√ò (mm)',          type: 'text',    required: false, custom: false },
      { key: 'lunghezza',   label: 'Lunghezza (m)',   type: 'number',  required: false, custom: false },
      { key: 'colore',      label: 'Colore',          type: 'text',    required: false, custom: false },
      { key: 'quantita',    label: 'Quantit√†',        type: 'number',  required: false, custom: false },
      { key: 'quantita_min',label: 'Scorta minima',   type: 'number',  required: false, custom: false, placeholder: 'Scorta minima' },
      { key: 'note',        label: 'Note',            type: 'textarea',required: false, custom: false },
    ],
    items: []
  },
  {
    id: 'ami',
    name: 'Ami',
    icon: 'ü™ù',
    collapsed: true,
    fields: [
      { key: 'marca',       label: 'Marca',          type: 'text',    required: true,  custom: false },
      { key: 'misura',      label: 'Misura',         type: 'text',    required: false, custom: false, placeholder: 'es. 2, 1/0, 4/0' },
      { key: 'tipo',        label: 'Tipo',           type: 'text',    required: false, custom: false, placeholder: 'es. Limerick, Aberdeen' },
      { key: 'quantita',    label: 'Quantit√†',        type: 'number',  required: false, custom: false },
      { key: 'quantita_min',label: 'Scorta minima',   type: 'number',  required: false, custom: false, placeholder: 'Scorta minima' },
      { key: 'note',        label: 'Note',            type: 'textarea',required: false, custom: false },
    ],
    items: []
  },
  {
    id: 'shock',
    name: 'Shock Leader',
    icon: 'üí™',
    collapsed: true,
    fields: [
      { key: 'marca',       label: 'Marca',          type: 'text',    required: true,  custom: false },
      { key: 'materiale',   label: 'Materiale',      type: 'text',    required: false, custom: false, placeholder: 'Nylon / Fluoro' },
      { key: 'diam',        label: '√ò (mm)',          type: 'text',    required: false, custom: false },
      { key: 'lunghezza',   label: 'Lunghezza (m)',   type: 'number',  required: false, custom: false },
      { key: 'note',        label: 'Note',            type: 'textarea',required: false, custom: false },
    ],
    items: []
  },
  {
    id: 'mulinelli',
    name: 'Mulinelli',
    icon: 'üéõÔ∏è',
    collapsed: true,
    fields: [
      { key: 'marca',       label: 'Marca',            type: 'text',    required: true,  custom: false },
      { key: 'modello',     label: 'Modello',          type: 'text',    required: false, custom: false },
      { key: 'rapporto',    label: 'Rapporto',         type: 'text',    required: false, custom: false, placeholder: 'es. 5.2:1' },
      { key: 'capacita',    label: 'Capacit√† filo',    type: 'text',    required: false, custom: false, placeholder: 'es. 200m 0.30' },
      { key: 'stato',       label: 'Stato',            type: 'text',    required: false, custom: false, placeholder: 'Ottimo / Buono / Da revisionare' },
      { key: 'note',        label: 'Note',             type: 'textarea',required: false, custom: false },
    ],
    items: []
  },
  {
    id: 'bobbine',
    name: 'Bobbine',
    icon: 'ü™°',
    collapsed: true,
    fields: [
      { key: 'marca',       label: 'Marca',            type: 'text',    required: true,  custom: false },
      { key: 'modello',     label: 'Modello',          type: 'text',    required: false, custom: false },
      { key: 'tipo',        label: 'Tipo',             type: 'text',    required: false, custom: false, placeholder: 'es. Porta-filo, Extra, Spare' },
      { key: 'capacita',    label: 'Capacit√† (m/mm)',  type: 'text',    required: false, custom: false, placeholder: 'es. 300m / 0.30' },
      { key: 'compatibile', label: 'Compatibile con',  type: 'text',    required: false, custom: false, placeholder: 'es. Shimano Ultegra 14000' },
      { key: 'stato',       label: 'Stato',            type: 'text',    required: false, custom: false, placeholder: 'Ottimo / Buono / Da revisionare' },
      { key: 'note',        label: 'Note',             type: 'textarea',required: false, custom: false },
    ],
    items: []
  },
  {
    id: 'canne',
    name: 'Canne',
    icon: 'üé£',
    collapsed: true,
    fields: [
      { key: 'marca',       label: 'Marca',            type: 'text',    required: true,  custom: false },
      { key: 'modello',     label: 'Modello',          type: 'text',    required: false, custom: false },
      { key: 'lunghezza',   label: 'Lunghezza (m)',    type: 'text',    required: false, custom: false, placeholder: 'es. 4.20' },
      { key: 'potenza',     label: 'Potenza (g)',      type: 'text',    required: false, custom: false, placeholder: 'es. 40-150' },
      { key: 'stato',       label: 'Stato',            type: 'text',    required: false, custom: false, placeholder: 'Ottimo / Buono / Da riparare' },
      { key: 'note',        label: 'Note',             type: 'textarea',required: false, custom: false },
    ],
    items: []
  },
  {
    id: 'accessori',
    name: 'Accessori',
    icon: 'üß∞',
    collapsed: true,
    fields: [
      { key: 'nome',        label: 'Nome',            type: 'text',    required: true,  custom: false },
      { key: 'desc',        label: 'Descrizione',     type: 'text',    required: false, custom: false },
      { key: 'quantita',    label: 'Quantit√†',         type: 'number',  required: false, custom: false },
      { key: 'note',        label: 'Note',             type: 'textarea',required: false, custom: false },
    ],
    items: []
  },
];

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  STATE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let state = { sections: [] };
let _editSectionId  = null;
let _editItemId     = null;
let _fieldsSectionId = null;
let _searchQuery    = '';

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  PERSISTENCE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadData() {
  try {
    const raw = localStorage.getItem('surfcasting_data');
    if (raw) {
      const saved = JSON.parse(raw);
      // Merge: add any new default sections not yet in saved
      const ids = saved.sections.map(s => s.id);
      DEFAULTS.forEach(def => {
        if (!ids.includes(def.id)) saved.sections.push(JSON.parse(JSON.stringify(def)));
      });
      // Merge nuovi campi predefiniti nelle sezioni esistenti
      saved.sections.forEach(section => {
        const def = DEFAULTS.find(d => d.id === section.id);
        if (!def) return;
        def.fields.forEach(defField => {
          if (!defField.custom && !section.fields.find(f => f.key === defField.key)) {
            const noteIdx = section.fields.findIndex(f => f.key === 'note');
            if (noteIdx !== -1) section.fields.splice(noteIdx, 0, { ...defField });
            else section.fields.push({ ...defField });
          }
        });
      });
      // Riordina secondo l'ordine dei DEFAULTS (le sezioni custom vanno in fondo)
      const defOrder = DEFAULTS.map(d => d.id);
      saved.sections.sort((a, b) => {
        const ia = defOrder.indexOf(a.id);
        const ib = defOrder.indexOf(b.id);
        return (ia === -1 ? 999 : ia) - (ib === -1 ? 999 : ib);
      });
      state = saved;
    } else {
      state = { sections: JSON.parse(JSON.stringify(DEFAULTS)) };
    }
  } catch(e) {
    state = { sections: JSON.parse(JSON.stringify(DEFAULTS)) };
  }
}

function saveData(silent = false) {
  try {
    localStorage.setItem('surfcasting_data', JSON.stringify(state));
    if (!silent) showToast('Salvato ‚úì', 'success');
  } catch(e) {
    showToast('Errore nel salvataggio!', 'error');
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  EXPORT / IMPORT
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function exportData() {
  const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href = url;
  a.download = `archivio-surfcasting-${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(url);
  showToast('Esportazione completata', 'success');
  closeGearDropdown();
}

function importData(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const imported = JSON.parse(e.target.result);
      if (!imported.sections || !Array.isArray(imported.sections))
        throw new Error('Formato non valido');
      state = imported;
      saveData(true);
      renderAll();
      showToast('Importazione completata ‚úì', 'success');
    } catch(err) {
      showToast('File JSON non valido!', 'error');
    }
    event.target.value = '';
    closeGearDropdown();
  };
  reader.readAsText(file);
}

function confirmClearAll() {
  if (confirm(t('reset_confirm'))) {
    state = { sections: JSON.parse(JSON.stringify(DEFAULTS)) };
    saveData(true);
    renderAll();
    showToast(t('reset_done'), 'success');
    closeGearDropdown();
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  RENDER
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderAll() {
  const container = document.getElementById('sections-container');
  container.innerHTML = '';
  state.sections.forEach(s => container.appendChild(renderSection(s)));
}

function renderSection(s) {
  const q = _searchQuery.toLowerCase();
  const filteredItems = q
    ? s.items.filter(item =>
        Object.values(item).some(v => String(v).toLowerCase().includes(q))
      )
    : s.items;

  const card = document.createElement('div');
  card.className = 'section-card' + (s.collapsed ? '' : ' open');
  card.dataset.id = s.id;

  // Header
  const hdr = document.createElement('div');
  hdr.className = 'section-header';
  hdr.onclick = () => toggleSection(s.id);
  const sectionName = t('section_' + s.id) || s.name;
  hdr.innerHTML = `
    <span class="section-icon">${s.icon}</span>
    <span class="section-title">${esc(sectionName)}</span>
    <span class="section-badge">${filteredItems.length}${q && filteredItems.length !== s.items.length ? '/'+s.items.length : ''}</span>
    <div class="section-header-actions" onclick="event.stopPropagation()">
      <button class="btn btn-ghost btn-add-item" onclick="openItemModal('${s.id}')" title="${t('add')}"><span class="btn-label">${t('add')}</span></button>
      <button class="btn btn-ghost btn-open-fields" onclick="openFieldsModal('${s.id}')" title="${t('fields')}"><span class="btn-label">${t('fields')}</span></button>
    </div>
    <span class="chevron">‚ñº</span>
  `;

  // Body
  const body = document.createElement('div');
  body.className = 'section-body';

  const inner = document.createElement('div');
  inner.className = 'section-body-inner';

  // Table
  const visibleFields = s.fields.filter(f => f.key !== 'note');
  const wrap = document.createElement('div');
  wrap.className = 'table-wrap';

  let thead = `<thead><tr>`;
  visibleFields.forEach(f => { thead += `<th>${esc(f.label)}</th>`; });
  thead += `<th>${t('note')}</th><th style="width:80px"></th></tr></thead>`;

  let tbody = `<tbody>`;
  if (filteredItems.length === 0) {
    tbody += `<tr class="empty-row"><td colspan="${visibleFields.length + 2}">${t('empty_msg')}</td></tr>`;
  } else {
    filteredItems.forEach(item => {
      const qtyMin = Number(item.quantita_min) || 0;
      const qty    = Number(item.quantita)     || 0;
      const isLow  = qtyMin > 0 && qty <= qtyMin;
      tbody += `<tr${isLow ? ' class="low-stock"' : ''}>`;
      visibleFields.forEach(f => {
        const val = item[f.key] !== undefined ? String(item[f.key]) : '‚Äî';
        if (f.key === 'quantita' && isLow) {
          tbody += `<td>${highlight(esc(val), q)} <span class="low-stock-badge">${t('low_stock')}</span></td>`;
        } else {
          tbody += `<td>${highlight(esc(val), q)}</td>`;
        }
      });
      // Note column
      const noteField = s.fields.find(f => f.key === 'note');
      const noteVal = noteField ? (item['note'] || '‚Äî') : '‚Äî';
      tbody += `<td style="max-width:220px;color:var(--text-secondary);font-size:.88rem;line-height:1.4">${highlight(esc(noteVal), q)}</td>`;
      tbody += `<td><div class="td-actions">
        <button title="Modifica" onclick="openItemModal('${s.id}','${item.id}')">‚úèÔ∏è</button>
        <button title="Elimina" class="btn-del" onclick="deleteItem('${s.id}','${item.id}')">üóëÔ∏è</button>
      </div></td>`;
      tbody += `</tr>`;
    });
  }
  tbody += `</tbody>`;

  wrap.innerHTML = `<table>${thead}${tbody}</table>`;
  inner.appendChild(wrap);

  // Mobile card view
  const cardList = document.createElement('div');
  cardList.className = 'mobile-card-list';
  if (filteredItems.length === 0) {
    cardList.innerHTML = `<p style="text-align:center;color:var(--text-muted);padding:2rem 1rem;font-style:italic;font-size:.9rem">${t('empty_msg')}</p>`;
  } else {
    filteredItems.forEach(item => {
      const qtyMin = Number(item.quantita_min) || 0;
      const qty    = Number(item.quantita)     || 0;
      const isLow  = qtyMin > 0 && qty <= qtyMin;
      const card = document.createElement('div');
      card.className = 'mobile-card' + (isLow ? ' low-stock' : '');
      let rows = '';
      s.fields.forEach(f => {
        const val = item[f.key] !== undefined && item[f.key] !== '' ? String(item[f.key]) : null;
        if (!val) return;
        rows += `<div class="mobile-card-row">
          <span class="mobile-card-key">${esc(f.label)}</span>
          <span class="mobile-card-val">${highlight(esc(val), q)}</span>
        </div>`;
      });
      card.innerHTML = `${rows}
        <div class="mobile-card-actions">
          <button class="btn btn-ghost" onclick="openItemModal('${s.id}','${item.id}')">‚úèÔ∏è Modifica</button>
          <button class="btn btn-danger" onclick="deleteItem('${s.id}','${item.id}')">üóëÔ∏è Elimina</button>
        </div>`;
      cardList.appendChild(card);
    });
  }
  inner.appendChild(cardList);
  body.appendChild(inner);

  card.appendChild(hdr);
  card.appendChild(body);
  return card;
}

function highlight(text, q) {
  if (!q || text === '‚Äî') return text;
  const re = new RegExp('(' + q.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi');
  return text.replace(re, '<mark>$1</mark>');
}

function esc(str) {
  return String(str)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  COLLAPSE / EXPAND
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleSection(id) {
  const s = getSection(id);
  s.collapsed = !s.collapsed;
  // Update DOM without full re-render for perf
  const card = document.querySelector(`.section-card[data-id="${id}"]`);
  if (card) {
    if (s.collapsed) card.classList.remove('open');
    else card.classList.add('open');
  }
  saveData(true);
}

function toggleAll(expand) {
  state.sections.forEach(s => { s.collapsed = !expand; });
  document.querySelectorAll('.section-card').forEach(card => {
    if (expand) card.classList.add('open');
    else card.classList.remove('open');
  });
  saveData(true);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  ITEM MODAL
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openItemModal(sectionId, itemId = null) {
  _editSectionId = sectionId;
  _editItemId    = itemId;
  const s    = getSection(sectionId);
  const item = itemId ? s.items.find(i => i.id === itemId) : null;

  document.getElementById('itemModalTitle').textContent =
    item ? `Modifica ‚Äî ${s.name}` : `Aggiungi ‚Äî ${s.name}`;

  const form = document.getElementById('itemModalForm');
  form.innerHTML = '';

  s.fields.forEach(f => {
    const val  = item ? (item[f.key] ?? '') : '';
    const full = f.type === 'textarea' ? ' full' : '';
    const ph   = f.placeholder ? `placeholder="${esc(f.placeholder)}"` : '';
    let input;
    if (f.type === 'textarea') {
      input = `<textarea id="field_${f.key}" rows="3" ${ph}>${esc(val)}</textarea>`;
    } else {
      input = `<input type="${f.type === 'number' ? 'number' : 'text'}" id="field_${f.key}" value="${esc(val)}" ${ph} />`;
    }
    form.insertAdjacentHTML('beforeend', `
      <div class="form-group${full}">
        <label for="field_${f.key}">${esc(f.label)}${f.required ? ' *' : ''}</label>
        ${input}
      </div>
    `);
  });

  document.getElementById('itemModal').style.display = 'flex';
  // Focus first input
  const first = form.querySelector('input, select, textarea');
  if (first) setTimeout(() => first.focus(), 100);
}

function closeItemModal(event) {
  if (event && event.target !== document.getElementById('itemModal')) return;
  document.getElementById('itemModal').style.display = 'none';
  _editSectionId = _editItemId = null;
}

function saveItem() {
  const s = getSection(_editSectionId);
  const item = _editItemId ? s.items.find(i => i.id === _editItemId) : { id: uid() };

  let valid = true;
  s.fields.forEach(f => {
    const el = document.getElementById('field_' + f.key);
    if (!el) return;
    const val = el.value.trim();
    if (f.required && !val) {
      el.style.borderColor = 'var(--danger)';
      valid = false;
    } else {
      el.style.borderColor = '';
      item[f.key] = f.type === 'number' ? (val === '' ? '' : Number(val)) : val;
    }
  });
  if (!valid) { showToast('Compila i campi obbligatori (*)', 'error'); return; }

  if (!_editItemId) s.items.push(item);

  saveData();
  closeItemModal();
  rerenderSection(s.id);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  DELETE ITEM
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function deleteItem(sectionId, itemId) {
  if (!confirm('Eliminare questo elemento?')) return;
  const s = getSection(sectionId);
  s.items = s.items.filter(i => i.id !== itemId);
  saveData();
  rerenderSection(s.id);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  FIELDS MODAL
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openFieldsModal(sectionId) {
  _fieldsSectionId = sectionId;
  const s = getSection(sectionId);
  document.getElementById('fieldsModalTitle').textContent = `Campi ‚Äî ${s.name}`;
  renderFieldsList(s);
  document.getElementById('newFieldName').value = '';
  document.getElementById('fieldsModal').style.display = 'flex';
}

function renderFieldsList(s) {
  const list = document.getElementById('fieldsModalList');
  list.innerHTML = '';
  s.fields.forEach(f => {
    const row = document.createElement('div');
    row.className = 'field-row';
    row.innerHTML = `
      <span class="field-label">${esc(f.label)}</span>
      <span class="field-type">${f.type}</span>
      ${f.custom ? '' : '<span class="field-default">predefinito</span>'}
      ${f.custom
        ? `<button class="btn-del-field" onclick="removeCustomField('${f.key}')" title="Rimuovi campo">‚úï</button>`
        : ''}
    `;
    list.appendChild(row);
  });
}

function addCustomField() {
  const nameEl = document.getElementById('newFieldName');
  const typeEl = document.getElementById('newFieldType');
  const name   = nameEl.value.trim();
  const type   = typeEl.value;
  if (!name) { nameEl.focus(); return; }

  const s   = getSection(_fieldsSectionId);
  const key = 'custom_' + name.toLowerCase().replace(/\s+/g,'_').replace(/[^a-z0-9_]/g,'') + '_' + Date.now();

  s.fields.push({ key, label: name, type, required: false, custom: true });
  nameEl.value = '';
  saveData();
  renderFieldsList(s);
  rerenderSection(s.id);
}

function removeCustomField(key) {
  const s = getSection(_fieldsSectionId);
  if (!confirm('Rimuovere il campo? I dati in questo campo verranno persi.')) return;
  s.fields = s.fields.filter(f => f.key !== key);
  s.items.forEach(item => delete item[key]);
  saveData();
  renderFieldsList(s);
  rerenderSection(s.id);
}

function closeFieldsModal(event) {
  if (event && event.target !== document.getElementById('fieldsModal')) return;
  document.getElementById('fieldsModal').style.display = 'none';
  _fieldsSectionId = null;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  SEARCH
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function filterAll() {
  _searchQuery = document.getElementById('globalSearch').value.trim();
  // Expand all sections if searching
  if (_searchQuery) {
    state.sections.forEach(s => { s.collapsed = false; });
  }
  renderAll();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  HELPERS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getSection(id) { return state.sections.find(s => s.id === id); }

function uid() { return Math.random().toString(36).slice(2) + Date.now().toString(36); }

function rerenderSection(id) {
  const s   = getSection(id);
  const old = document.querySelector(`.section-card[data-id="${id}"]`);
  if (!old) { renderAll(); return; }
  const fresh = renderSection(s);
  old.parentNode.replaceChild(fresh, old);
}

function showToast(msg, type = 'success') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'show toast-' + type;
  clearTimeout(t._timer);
  t._timer = setTimeout(() => { t.className = ''; }, 2500);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  KEYBOARD SHORTCUTS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    closeItemModal();
    closeFieldsModal();
    closePartnerModal();
    closePrivacyModal();
  }
  // Ctrl/Cmd + F ‚Üí focus search
  if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
    e.preventDefault();
    document.getElementById('globalSearch').focus();
  }
  // Ctrl/Cmd + S ‚Üí save (no-op: auto save, but feedback)
  if ((e.ctrlKey || e.metaKey) && e.key === 's') {
    e.preventDefault();
    saveData();
  }
  // Enter in item modal form
  if (e.key === 'Enter' && document.getElementById('itemModal').style.display !== 'none') {
    const active = document.activeElement;
    if (active && active.tagName !== 'TEXTAREA') saveItem();
  }
});

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  PARTNER & SPONSOR
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const PARTNER_CATEGORIES = {
  negozi:       { label: 'Negozio di pesca',   fields: ['neg-nome','neg-tel','neg-email','neg-indirizzo','neg-sito','neg-note'],   keys: ['nome','tel','email','indirizzo','sito','note'] },
  associazioni: { label: 'Associazione',        fields: ['ass-nome','ass-tel','ass-email','ass-desc','ass-sito','ass-note'],        keys: ['nome','tel','email','desc','sito','note'] },
  maestri:      { label: 'Maestro di pesca',    fields: ['mae-nome','mae-tel','mae-email','mae-spec','mae-note'],                   keys: ['nome','tel','email','spec','note'] },
};
let _partnerEditId   = null;
let _partnerEditCat  = null;
let _activePartnerTab = 'negozi';

function loadPartners() {
  try {
    const raw = localStorage.getItem('surfcasting_partners');
    return raw ? JSON.parse(raw) : { negozi: [], associazioni: [], maestri: [] };
  } catch(e) { return { negozi: [], associazioni: [], maestri: [] }; }
}
function savePartners(data) {
  localStorage.setItem('surfcasting_partners', JSON.stringify(data));
}

function openPartnerModal() {
  _partnerEditId = _partnerEditCat = null;
  renderPartnerLists();
  document.getElementById('partnerModal').style.display = 'flex';
}
function closePartnerModal(event) {
  if (event && event.target !== document.getElementById('partnerModal')) return;
  document.getElementById('partnerModal').style.display = 'none';
}

function switchPartnerTab(cat, btn) {
  _activePartnerTab = cat;
  document.querySelectorAll('.partner-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.partner-panel').forEach(p => p.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('panel-' + cat).classList.add('active');
  cancelPartnerForm(cat);
}

function openPartnerForm(cat, editId = null) {
  const cfg   = PARTNER_CATEGORIES[cat];
  const data  = loadPartners();
  const entry = editId ? data[cat].find(e => e.id === editId) : null;
  _partnerEditId  = editId;
  _partnerEditCat = cat;
  cfg.fields.forEach((fid, i) => {
    const el = document.getElementById(fid);
    if (el) el.value = entry ? (entry[cfg.keys[i]] || '') : '';
  });
  document.getElementById('form-' + cat).classList.add('open');
}

function cancelPartnerForm(cat) {
  const form = document.getElementById('form-' + cat);
  if (form) form.classList.remove('open');
  _partnerEditId = _partnerEditCat = null;
}

function savePartner(cat) {
  const cfg   = PARTNER_CATEGORIES[cat];
  const nome  = document.getElementById(cfg.fields[0]).value.trim();
  if (!nome) { document.getElementById(cfg.fields[0]).focus(); return; }
  const data  = loadPartners();
  const entry = _partnerEditId ? data[cat].find(e => e.id === _partnerEditId) : { id: uid() };
  cfg.fields.forEach((fid, i) => {
    const el = document.getElementById(fid);
    if (el) entry[cfg.keys[i]] = el.value.trim();
  });
  if (!_partnerEditId) data[cat].push(entry);
  savePartners(data);
  cancelPartnerForm(cat);
  renderPartnerList(cat);
  showToast('Salvato ‚úì', 'success');
}

function deletePartner(cat, id) {
  if (!confirm('Eliminare questo elemento?')) return;
  const data = loadPartners();
  data[cat] = data[cat].filter(e => e.id !== id);
  savePartners(data);
  renderPartnerList(cat);
}

function renderPartnerLists() {
  ['negozi','associazioni','maestri'].forEach(renderPartnerList);
  updatePartnerCounts();
}

function updatePartnerCounts() {
  const data = loadPartners();
  ['negozi','associazioni','maestri'].forEach(cat => {
    const countEl = document.getElementById('count-' + cat);
    if (countEl) {
      const n = (data[cat] || []).length;
      countEl.textContent = n > 0 ? `(${n})` : '';
    }
  });
  // Aggiorna banner
  const banner = document.getElementById('partnerBanner');
  if (banner) banner.textContent = t('partner_banner');
}

const PARTNER_ICONS = { negozi: 'üè™', associazioni: 'üèÖ', maestri: 'üéì' };

function renderPartnerList(cat) {
  const data  = loadPartners();
  const list  = document.getElementById('list-' + cat);
  const items = data[cat] || [];
  if (items.length === 0) {
    list.innerHTML = `<div class="partner-empty">${t('empty_msg')}</div>`;
    return;
  }
  list.innerHTML = items.map(e => {
    const details = [
      e.tel    ? `üìû ${esc(e.tel)}`    : '',
      e.email  ? `‚úâÔ∏è ${esc(e.email)}`  : '',
      e.indirizzo ? `üìç ${esc(e.indirizzo)}` : '',
      e.desc   ? esc(e.desc)           : '',
      e.spec   ? `üéØ ${esc(e.spec)}`   : '',
      e.sito   ? `<a href="${esc(e.sito)}" target="_blank" rel="noopener">üåê ${esc(e.sito)}</a>` : '',
      e.note   ? `<em>${esc(e.note)}</em>` : '',
    ].filter(Boolean).join(' ¬∑ ');
    return `<div class="partner-entry">
      <span class="partner-icon-circle ${cat}">${PARTNER_ICONS[cat] || ''}</span>
      <div class="partner-entry-info" style="flex:1">
        <div class="partner-entry-name">${esc(e.nome)}</div>
        ${details ? `<div class="partner-entry-details">${details}</div>` : ''}
      </div>
      <div class="partner-entry-actions">
        <button onclick="openPartnerForm('${cat}','${e.id}')" title="${t('edit_title')}">‚úèÔ∏è</button>
        <button class="btn-del-p" onclick="deletePartner('${cat}','${e.id}')" title="${t('delete_confirm')}">üóëÔ∏è</button>
      </div>
    </div>`;
  }).join('');
  updatePartnerCounts();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  GEAR DROPDOWN
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleSettingsPanel() {
  const drop = document.getElementById('gearDropdown');
  const gear = document.getElementById('settingsGearBtn');
  const isOpen = drop.classList.toggle('open');
  gear.classList.toggle('active', isOpen);
}

function closeGearDropdown() {
  document.getElementById('gearDropdown').classList.remove('open');
  document.getElementById('settingsGearBtn').classList.remove('active');
}

// Chiudi il dropdown cliccando fuori
document.addEventListener('click', e => {
  const wrapper = document.querySelector('.gear-wrapper');
  const dropdown = document.getElementById('gearDropdown');
  if (wrapper && !wrapper.contains(e.target) && dropdown && !dropdown.contains(e.target)) {
    dropdown.classList.remove('open');
    document.getElementById('settingsGearBtn').classList.remove('active');
  }
});

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  TRANSLATIONS & LANGUAGE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const TRANSLATIONS = {
  IT: {
    section_travi: 'Travi', section_terminali: 'Terminali', section_piombi: 'Piombi',
    section_fili: 'Fili', section_ami: 'Ami', section_shock: 'Shock Leader',
    section_mulinelli: 'Mulinelli', section_bobbine: 'Bobbine', section_canne: 'Canne',
    section_accessori: 'Accessori',
    add: '+ Aggiungi', fields: '‚öô Campi',
    add_title: 'Aggiungi elemento', edit_title: 'Modifica',
    save: 'Salva', cancel: 'Annulla', close: 'Chiudi', delete_confirm: 'Eliminare questo elemento?',
    expand_all: '‚äû Espandi tutto', collapse_all: '‚äü Collassa tutto',
    search_placeholder: 'Cerca in tutto l\'archivio‚Ä¶',
    empty_msg: 'Nessun elemento. Usa "+ Aggiungi" per iniziare.',
    saved: 'Salvato ‚úì', save_error: 'Errore nel salvataggio!',
    exported: 'Archivio esportato ‚úì', imported: 'Importato ‚úì',
    import_error: 'File non valido.', reset_confirm: 'Eliminare TUTTI i dati?',
    reset_done: 'Tutti i dati sono stati eliminati.',
    note: 'Note', low_stock: 'Scorta bassa',
    fields_info: 'I campi predefiniti non possono essere rimossi. Puoi aggiungere campi custom.',
    new_field_placeholder: 'Nome nuovo campo‚Ä¶',
    field_type_text: 'Testo', field_type_number: 'Numero', field_type_textarea: 'Nota lunga',
    cookie_title: 'Cookie & Privacy',
    cookie_text: 'Questa app utilizza localStorage per salvare i tuoi dati localmente sul dispositivo. Nessun dato viene inviato a server esterni.',
    cookie_accept: 'Accetto', cookie_privacy: 'Leggi la Privacy Policy',
    partner_title: 'Partner & Sponsor',
    partner_banner: 'Gestisci i tuoi contatti: negozi, associazioni e maestri di pesca',
    tab_negozi: 'Negozi di pesca', tab_associazioni: 'Associazioni', tab_maestri: 'Maestri di pesca',
    add_negozio: '+ Aggiungi negozio', add_associazione: '+ Aggiungi associazione', add_maestro: '+ Aggiungi maestro',
    privacy_title: 'Privacy Policy',
    export_btn: 'Esporta archivio', import_btn: 'Importa archivio', reset_btn: 'Reset completo',
    lang_btn: 'Lingua', sections_label: 'Sezioni:',
  },
  EN: {
    section_travi: 'Rigs', section_terminali: 'Leaders', section_piombi: 'Sinkers',
    section_fili: 'Lines', section_ami: 'Hooks', section_shock: 'Shock Leaders',
    section_mulinelli: 'Reels', section_bobbine: 'Spools', section_canne: 'Rods',
    section_accessori: 'Accessories',
    add: '+ Add', fields: '‚öô Fields',
    add_title: 'Add item', edit_title: 'Edit',
    save: 'Save', cancel: 'Cancel', close: 'Close', delete_confirm: 'Delete this item?',
    expand_all: '‚äû Expand all', collapse_all: '‚äü Collapse all',
    search_placeholder: 'Search the entire archive‚Ä¶',
    empty_msg: 'No items. Use "+ Add" to start.',
    saved: 'Saved ‚úì', save_error: 'Error saving!',
    exported: 'Archive exported ‚úì', imported: 'Imported ‚úì',
    import_error: 'Invalid file.', reset_confirm: 'Delete ALL data?',
    reset_done: 'All data has been deleted.',
    note: 'Notes', low_stock: 'Low stock',
    fields_info: 'Default fields cannot be removed. You can add custom fields.',
    new_field_placeholder: 'New field name‚Ä¶',
    field_type_text: 'Text', field_type_number: 'Number', field_type_textarea: 'Long note',
    cookie_title: 'Cookie & Privacy',
    cookie_text: 'This app uses localStorage to save your data locally on the device. No data is sent to external servers.',
    cookie_accept: 'Accept', cookie_privacy: 'Read Privacy Policy',
    partner_title: 'Partners & Sponsors',
    partner_banner: 'Manage your contacts: shops, associations and fishing masters',
    tab_negozi: 'Fishing shops', tab_associazioni: 'Associations', tab_maestri: 'Fishing masters',
    add_negozio: '+ Add shop', add_associazione: '+ Add association', add_maestro: '+ Add master',
    privacy_title: 'Privacy Policy',
    export_btn: 'Export archive', import_btn: 'Import archive', reset_btn: 'Full reset',
    lang_btn: 'Language', sections_label: 'Sections:',
  },
  ES: {
    section_travi: 'Aparejos', section_terminali: 'Terminales', section_piombi: 'Plomos',
    section_fili: 'Hilos', section_ami: 'Anzuelos', section_shock: 'Shock Leaders',
    section_mulinelli: 'Carretes', section_bobbine: 'Bobinas', section_canne: 'Ca√±as',
    section_accessori: 'Accesorios',
    add: '+ A√±adir', fields: '‚öô Campos',
    add_title: 'A√±adir elemento', edit_title: 'Editar',
    save: 'Guardar', cancel: 'Cancelar', close: 'Cerrar', delete_confirm: '¬øEliminar este elemento?',
    expand_all: '‚äû Expandir todo', collapse_all: '‚äü Colapsar todo',
    search_placeholder: 'Buscar en todo el archivo‚Ä¶',
    empty_msg: 'Sin elementos. Usa "+ A√±adir" para empezar.',
    saved: 'Guardado ‚úì', save_error: '¬°Error al guardar!',
    exported: 'Archivo exportado ‚úì', imported: 'Importado ‚úì',
    import_error: 'Archivo no v√°lido.', reset_confirm: '¬øEliminar TODOS los datos?',
    reset_done: 'Todos los datos han sido eliminados.',
    note: 'Notas', low_stock: 'Stock bajo',
    fields_info: 'Los campos predeterminados no se pueden eliminar. Puedes a√±adir campos personalizados.',
    new_field_placeholder: 'Nombre del nuevo campo‚Ä¶',
    field_type_text: 'Texto', field_type_number: 'N√∫mero', field_type_textarea: 'Nota larga',
    cookie_title: 'Cookie y Privacidad',
    cookie_text: 'Esta app usa localStorage para guardar tus datos localmente. Ning√∫n dato se env√≠a a servidores externos.',
    cookie_accept: 'Acepto', cookie_privacy: 'Leer Pol√≠tica de Privacidad',
    partner_title: 'Socios y Patrocinadores',
    partner_banner: 'Gestiona tus contactos: tiendas, asociaciones y maestros de pesca',
    tab_negozi: 'Tiendas de pesca', tab_associazioni: 'Asociaciones', tab_maestri: 'Maestros de pesca',
    add_negozio: '+ A√±adir tienda', add_associazione: '+ A√±adir asociaci√≥n', add_maestro: '+ A√±adir maestro',
    privacy_title: 'Pol√≠tica de Privacidad',
    export_btn: 'Exportar archivo', import_btn: 'Importar archivo', reset_btn: 'Reset completo',
    lang_btn: 'Idioma', sections_label: 'Secciones:',
  },
  FR: {
    section_travi: 'Montages', section_terminali: 'Bas de ligne', section_piombi: 'Plombs',
    section_fili: 'Fils', section_ami: 'Hame√ßons', section_shock: 'Shock Leaders',
    section_mulinelli: 'Moulinets', section_bobbine: 'Bobines', section_canne: 'Cannes',
    section_accessori: 'Accessoires',
    add: '+ Ajouter', fields: '‚öô Champs',
    add_title: 'Ajouter un √©l√©ment', edit_title: 'Modifier',
    save: 'Enregistrer', cancel: 'Annuler', close: 'Fermer', delete_confirm: 'Supprimer cet √©l√©ment ?',
    expand_all: '‚äû Tout d√©plier', collapse_all: '‚äü Tout replier',
    search_placeholder: 'Rechercher dans toute l\'archive‚Ä¶',
    empty_msg: 'Aucun √©l√©ment. Utilisez "+ Ajouter" pour commencer.',
    saved: 'Enregistr√© ‚úì', save_error: 'Erreur de sauvegarde !',
    exported: 'Archive export√©e ‚úì', imported: 'Import√© ‚úì',
    import_error: 'Fichier invalide.', reset_confirm: 'Supprimer TOUTES les donn√©es ?',
    reset_done: 'Toutes les donn√©es ont √©t√© supprim√©es.',
    note: 'Notes', low_stock: 'Stock bas',
    fields_info: 'Les champs par d√©faut ne peuvent pas √™tre supprim√©s. Vous pouvez ajouter des champs personnalis√©s.',
    new_field_placeholder: 'Nom du nouveau champ‚Ä¶',
    field_type_text: 'Texte', field_type_number: 'Nombre', field_type_textarea: 'Note longue',
    cookie_title: 'Cookies et Confidentialit√©',
    cookie_text: 'Cette app utilise localStorage pour sauvegarder vos donn√©es localement. Aucune donn√©e n\'est envoy√©e √† des serveurs externes.',
    cookie_accept: 'J\'accepte', cookie_privacy: 'Lire la Politique de Confidentialit√©',
    partner_title: 'Partenaires et Sponsors',
    partner_banner: 'G√©rez vos contacts : magasins, associations et ma√Ætres de p√™che',
    tab_negozi: 'Magasins de p√™che', tab_associazioni: 'Associations', tab_maestri: 'Ma√Ætres de p√™che',
    add_negozio: '+ Ajouter magasin', add_associazione: '+ Ajouter association', add_maestro: '+ Ajouter ma√Ætre',
    privacy_title: 'Politique de Confidentialit√©',
    export_btn: 'Exporter archive', import_btn: 'Importer archive', reset_btn: 'R√©initialisation compl√®te',
    lang_btn: 'Langue', sections_label: 'Sections :',
  }
};

const LANGS = ['IT','EN','ES','FR'];
let _lang = localStorage.getItem('surfcasting_lang') || 'IT';

function t(key) {
  return (TRANSLATIONS[_lang] && TRANSLATIONS[_lang][key]) || (TRANSLATIONS.IT[key]) || key;
}

function cycleLang() {
  const idx = LANGS.indexOf(_lang);
  _lang = LANGS[(idx + 1) % LANGS.length];
  localStorage.setItem('surfcasting_lang', _lang);
  const label = document.getElementById('langLabel');
  if (label) label.textContent = _lang;
  renderAll();
  updateStaticTexts();
  showToast(_lang, 'success');
}

function updateStaticTexts() {
  // Search placeholder
  const search = document.getElementById('globalSearch');
  if (search) search.placeholder = t('search_placeholder');
  // Toolbar buttons
  const toolbar = document.querySelector('.toolbar');
  if (toolbar) {
    const title = toolbar.querySelector('.toolbar-title');
    if (title) title.textContent = t('sections_label');
    const btns = toolbar.querySelectorAll('.btn');
    if (btns[0]) btns[0].textContent = t('expand_all');
    if (btns[1]) btns[1].textContent = t('collapse_all');
  }
  // Lang label
  const label = document.getElementById('langLabel');
  if (label) label.textContent = _lang;
  // Cookie banner
  const cb = document.getElementById('cookieBanner');
  if (cb && cb.style.display !== 'none') {
    const ps = cb.querySelectorAll('p');
    if (ps[0]) ps[0].innerHTML = '<strong>' + t('cookie_title') + '</strong>';
    if (ps[1]) ps[1].textContent = t('cookie_text');
    const btns = cb.querySelectorAll('button');
    if (btns[0]) btns[0].textContent = t('cookie_accept');
    if (btns[1]) btns[1].textContent = t('cookie_privacy');
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  COOKIE BANNER
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initCookieBanner() {
  if (!localStorage.getItem('surfcasting_cookie_consent')) {
    document.getElementById('cookieBanner').style.display = 'block';
  }
}
function acceptCookies() {
  localStorage.setItem('surfcasting_cookie_consent', Date.now());
  document.getElementById('cookieBanner').style.display = 'none';
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  PRIVACY MODAL
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openPrivacyModal() {
  document.getElementById('privacyModal').style.display = 'flex';
}
function closePrivacyModal(event) {
  if (event && event.target !== document.getElementById('privacyModal')) return;
  document.getElementById('privacyModal').style.display = 'none';
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  INIT
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
loadData();
renderAll();
updateStaticTexts();
initCookieBanner();
</script>
</body>
</html>
